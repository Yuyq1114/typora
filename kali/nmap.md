# **Nmap 概述**

Nmap 主要用于以下任务：

- **网络发现**：识别网络上的活动主机。
- **端口扫描**：检测主机上开放的端口和服务。
- **服务识别**：确定运行在端口上的服务和版本。
- **操作系统检测**：识别主机的操作系统类型和版本。
- **漏洞扫描**：检测常见的安全漏洞和配置问题。

### 2. **主要功能和选项**

#### 2.1. **基本扫描**

- **扫描单个主机**：

  ```
  nmap [目标IP]
  ```
  
  例如，扫描 IP 地址为 `192.168.1.1` 的主机：

  ```
  nmap 192.168.1.1
  ```
  
- **扫描多个主机**：

  ```
  nmap [目标IP1] [目标IP2] [目标IP3]
  ```
  
  例如，扫描多个 IP 地址：

  ```
  nmap 192.168.1.1 192.168.1.2 192.168.1.3
  ```
  
- **扫描 IP 范围**：

  ```
  nmap 192.168.1.1-50
  ```
  
  例如，扫描从 `192.168.1.1` 到 `192.168.1.50` 的所有 IP 地址。

- **扫描子网**：

  ```
  nmap 192.168.1.0/24
  ```
  
  例如，扫描 `192.168.1.0` 子网的所有 IP 地址。

#### 2.2. **端口扫描**

- **扫描特定端口**：

  ```
  nmap -p [端口号] [目标IP]
  ```
  
  例如，扫描端口 `80` 和 `443`：

  ```
  nmap -p 80,443 192.168.1.1
  ```
  
- **扫描端口范围**：

  ```
  nmap -p [起始端口]-[结束端口] [目标IP]
  ```
  
  例如，扫描端口从 `1` 到 `1000`：

  ```
  nmap -p 1-1000 192.168.1.1
  ```
  
- **扫描所有端口**：

  ```
  nmap -p- [目标IP]
  ```
  
  例如，扫描所有 65535 个端口：

  ```
  nmap -p- 192.168.1.1
  ```

#### 2.3. **服务识别**

- **识别服务版本**：

  ```
  nmap -sV [目标IP]
  ```
  
  例如，识别主机上开放端口的服务版本：

  ```
  nmap -sV 192.168.1.1
  ```
  
- **识别操作系统**：

  ```
  nmap -O [目标IP]
  ```
  
  例如，识别主机的操作系统：

  ```
  nmap -O 192.168.1.1
  ```

#### 2.4. **高级扫描**

- **TCP 连接扫描**：

  ```
  nmap -sT [目标IP]
  ```
  
  例如，使用 TCP 连接扫描（通常较慢，但较全面）：

  ```
  nmap -sT 192.168.1.1
  ```
  
- **SYN 扫描**（快速扫描，不完整的连接）：

  ```
  nmap -sS [目标IP]
  ```
  
  例如，使用 SYN 扫描进行快速扫描：

  ```
  nmap -sS 192.168.1.1
  ```
  
- **UDP 扫描**：

  ```
  nmap -sU [目标IP]
  ```
  
  例如，扫描 UDP 端口：

  ```
  nmap -sU 192.168.1.1
  ```
  
- **扫描所有服务**：

  ```
  nmap -A [目标IP]
  ```
  
  例如，进行全面扫描（包括服务版本、操作系统、脚本扫描等）：

  ```
  nmap -A 192.168.1.1
  ```

#### 2.5. **脚本扫描**

- **使用 Nmap Scripting Engine (NSE)**：

  ```
  nmap --script [脚本名] [目标IP]
  ```
  
  例如，使用 `http-enum` 脚本扫描 HTTP 相关的漏洞：

  ```
  nmap --script http-enum 192.168.1.1
  ```
  
- **使用多个脚本**：

  ```
  nmap --script [脚本1],[脚本2] [目标IP]
  ```
  
  例如，运行多个脚本：

  ```
  nmap --script vuln,auth 192.168.1.1
  ```

### 3. **使用 Nmap 的实际示例**

#### 3.1. **基本网络扫描**

```
nmap 192.168.1.1
```

扫描主机 `192.168.1.1` 的所有默认端口。

#### 3.2. **扫描特定端口**

```
nmap -p 22,80,443 192.168.1.1
```

扫描主机 `192.168.1.1` 上的端口 22、80 和 443。

#### 3.3. **服务识别和操作系统检测**

```
nmap -sV -O 192.168.1.1
```

识别主机 `192.168.1.1` 上的服务版本和操作系统类型。

#### 3.4. **全面扫描**

```
nmap -A 192.168.1.1
```

进行全面的扫描，包括操作系统识别、服务版本检测和脚本扫描。

#### 3.5. **UDP 扫描**

```
nmap -sU -p 67,68 192.168.1.1
```

扫描主机 `192.168.1.1` 上的 UDP 端口 67 和 68。

### 4. **Nmap 脚本和扩展**

#### 4.1. **Nmap Scripting Engine (NSE)**

Nmap 脚本引擎允许用户使用 Lua 脚本扩展 Nmap 的功能。你可以使用内置脚本，也可以编写自定义脚本。

- **列出所有可用脚本**：

  ```
  nmap --script-help [脚本名]
  ```
  
  例如，获取 `http-enum` 脚本的帮助信息：

  ```
  nmap --script-help http-enum
  ```
  
- **运行脚本**：

  ```
  nmap --script [脚本名] [目标IP]
  ```
  
  例如，运行 `http-vuln-cve2014-0160` 脚本：

  ```
  nmap --script http-vuln-cve2014-0160 192.168.1.1
  ```

#### 4.2. **脚本分类**

- **vuln**：漏洞扫描脚本。
- **auth**：认证相关脚本。
- **discovery**：网络发现脚本。
- **exploit**：利用漏洞的脚本。

# 选项和参数

### 1. **基本扫描选项**

- **`-sS`**: **SYN 扫描**

  - 发送 SYN 数据包以进行快速的端口扫描（默认的隐蔽扫描方法）。

  - 示例：

    ```
    nmap -sS 192.168.1.1
    ```
  
- **`-sT`**: **TCP 连接扫描**

  - 完成三次握手建立连接进行端口扫描，适用于无法使用 SYN 扫描的情况。

  - 示例：

    ```
    nmap -sT 192.168.1.1
    ```
  
- **`-sU`**: **UDP 扫描**

  - 扫描目标主机上的 UDP 端口。

  - 示例：

    ```
    nmap -sU 192.168.1.1
    ```
  
- **`-sA`**: **ACK 扫描**

  - 用于检测防火墙规则和确定哪些端口是开放的（但不会告诉你是否有服务在运行）。

  - 示例：

    ```
    nmap -sA 192.168.1.1
    ```
  
- **`-sW`**: **窗口扫描**

  - 通过分析 TCP 窗口大小来确定端口的开放状态。

  - 示例：

    ```
    nmap -sW 192.168.1.1
    ```
  
- **`-sN`**: **NULL 扫描**

  - 发送没有任何标志的数据包以尝试绕过防火墙和入侵检测系统。

  - 示例：

    ```
    nmap -sN 192.168.1.1
    ```
  
- **`-sF`**: **FIN 扫描**

  - 发送 FIN 标志的数据包以探测端口状态。

  - 示例：

    ```
    nmap -sF 192.168.1.1
    ```

### 2. **扫描类型**

- **`-p`**: **指定端口**

  - 扫描指定的端口或端口范围。默认扫描 1-1024 端口。

  - 示例：

    ```
    nmap -p 80,443 192.168.1.1
    nmap -p 1-1000 192.168.1.1
    nmap -p- 192.168.1.1  # 扫描所有 65535 个端口
    ```

- **`-p-`**: **扫描所有端口**

  - 扫描所有可能的端口（1-65535）。

  - 示例：

    ```
    nmap -p- 192.168.1.1
    ```
  
- **`-p T:`**: **TCP 端口扫描**

  - 仅扫描 TCP 端口。

  - 示例：

    ```
    nmap -p T:80,443 192.168.1.1
    ```
  
- **`-p U:`**: **UDP 端口扫描**

  - 仅扫描 UDP 端口。

  - 示例：

    ```
    nmap -p U:53,67 192.168.1.1
    ```

### 3. **服务和操作系统检测**

- **`-sV`**: **服务版本检测**

  - 识别开放端口上运行的服务及其版本信息。

  - 示例：

    ```
    nmap -sV 192.168.1.1
    ```
  
- **`-O`**: **操作系统检测**

  - 尝试识别目标主机的操作系统。

  - 示例：

    ```
    nmap -O 192.168.1.1
    ```
  
- **`-A`**: **全面扫描**

  - 包括操作系统检测、服务版本检测、脚本扫描和跟踪 traceroute。

  - 示例：

    ```
    nmap -A 192.168.1.1
    ```

### 4. **脚本扫描**

- **`--script`**: **使用脚本**

  - 指定要运行的 Nmap 脚本。支持多种脚本类型，如漏洞检测、信息收集等。

  - 示例：

    ```
    nmap --script http-enum 192.168.1.1
    nmap --script vuln 192.168.1.1  # 运行所有漏洞相关的脚本
    ```

- **`--script-args`**: **传递脚本参数**

  - 向脚本传递参数，以便定制脚本的行为。

  - 示例：

    ```
    nmap --script http-enum --script-args http-enum.categories=admin 192.168.1.1
    ```

### 5. **输出格式**

- **`-oN`**: **普通输出**

  - 将扫描结果保存为普通文本格式。

  - 示例：

    ```
    nmap -oN scan.txt 192.168.1.1
    ```
  
- **`-oX`**: **XML 输出**

  - 将扫描结果保存为 XML 格式，便于进一步处理和分析。

  - 示例：

    ```
    nmap -oX scan.xml 192.168.1.1
    ```
  
- **`-oG`**: **Grepable 输出**

  - 将扫描结果保存为适合使用 grep 工具进一步处理的格式。

  - 示例：

    ```
    nmap -oG scan.gnmap 192.168.1.1
    ```
  
- **`-oA`**: **所有格式输出**

  - 将扫描结果保存为普通文本、XML 和 grepable 格式。

  - 示例：

    ```
    nmap -oA scan 192.168.1.1
    ```

### 6. **扫描控制**

- **`-T`**: **时间模板**

  - 控制扫描速度和隐蔽性。取值从 0（最慢）到 5（最快）。

  - 示例：

    ```
    nmap -T4 192.168.1.1
    ```
  
- **`--min-rate`**: **最小速率**

  - 设置发送数据包的最小速率（包/秒）。

  - 示例：

    ```
    nmap --min-rate 1000 192.168.1.1
    ```
  
- **`--max-retries`**: **最大重试次数**

  - 设置在尝试扫描端口时的最大重试次数。

  - 示例：

    ```
    nmap --max-retries 3 192.168.1.1
    ```
  
- **`--scan-delay`**: **扫描延迟**

  - 设置每个数据包之间的延迟（以毫秒为单位）。

  - 示例：

    ```
    nmap --scan-delay 100ms 192.168.1.1
    ```

### 7. **目标选择**

- **`-iL`**: **从文件中读取目标**

  - 从文件中读取多个目标地址进行扫描。

  - 示例：

    ```
    nmap -iL targets.txt
    ```
  
- **`-iR`**: **随机扫描**

  - 扫描随机生成的 IP 地址。

  - 示例：

    ```
    nmap -iR 100
    ```
  
- **`-Pn`**: **禁用主机发现**

  - 跳过主机发现阶段，直接扫描目标。

  - 示例：

    ```
    nmap -Pn 192.168.1.1
    ```

### 8. **其他实用参数**

- **`--traceroute`**: **跟踪路由**

  - 显示到目标主机的路由路径。

  - 示例：

    ```
    nmap --traceroute 192.168.1.1
    ```
  
- **`--version-all`**: **显示所有版本信息**

  - 显示详细的 Nmap 版本信息和所有相关的版本信息。

  - 示例：

    ```
    nmap --version-all
    ```
  
- **`-v`**: **详细模式**

  - 增加输出的详细级别。使用 `-v` 增加详细程度，使用 `-vv` 或 `-vvv` 进一步增加。

  - 示例：

    ```
    nmap -v 192.168.1.1
    ```
  
- **`--append-output`**: **追加输出**

  - 将扫描结果追加到已有的输出文件中，而不是覆盖文件。

  - 示例：

    ```
    nmap -oN scan.txt --append-output 192.168.1.1
    ```



# 扫描漏洞

Nmap 是一个强大的网络扫描工具，主要用于发现网络设备和端口。虽然 Nmap 不专门用于漏洞扫描，但它可以与Nmap脚本引擎（NSE）一起使用，进行一些基本的漏洞扫描和检测。以下是使用 Nmap 扫描网站漏洞的步骤：

### 安装Nmap

确保已安装Nmap。如果尚未安装，请按照以下步骤进行安装：

- **Windows**：从Nmap官方网站下载并安装。

- Linux

  ：

  ```
  sudo apt-get install nmap   # Debian/Ubuntu
  sudo yum install nmap       # CentOS/RHEL
  sudo pacman -S nmap         # Arch Linux
  ```

- macOS

  ：

  ```
  brew install nmap           # 使用Homebrew
  ```

### 使用Nmap脚本引擎（NSE）

Nmap的脚本引擎（NSE）提供了多种脚本，可以用来执行各种任务，包括漏洞扫描。Nmap的脚本存储在`/usr/share/nmap/scripts/`（Linux）或 `C:\Program Files (x86)\Nmap\scripts\`（Windows）目录下。

#### 查找可用的漏洞扫描脚本

你可以使用以下命令来查看Nmap自带的所有脚本：

```
ls /usr/share/nmap/scripts/
```

或者：

```
nmap --script-help
```

#### 常用漏洞扫描脚本

一些常见的用于漏洞扫描的Nmap脚本包括：

- `http-vuln-cve2017-5638`: 检测Apache Struts2远程代码执行漏洞（CVE-2017-5638）
- `http-sql-injection`: 检测SQL注入漏洞
- `http-vuln-cve2013-0156`: 检测Ruby on Rails XML参数处理漏洞（CVE-2013-0156）

### 扫描网站漏洞的示例

以下是一些使用Nmap扫描网站漏洞的示例：

#### 1. 扫描Apache Struts2漏洞（CVE-2017-5638）

```
nmap -p 80 --script http-vuln-cve2017-5638 example.com
```

#### 2. 扫描SQL注入漏洞

```
nmap -p 80 --script http-sql-injection example.com
```

#### 3. 扫描多个常见漏洞

```
nmap -p 80,443 --script vuln example.com
```

`vuln`脚本集将运行多个常见漏洞检测脚本，包括检测MS17-010（永恒之蓝）漏洞、Heartbleed漏洞、HTTP远程代码执行等。

### 详细扫描报告

为了获得更详细的扫描报告，你可以使用以下选项：

- `-v`：启用详细输出
- `-oN`：将输出保存到文本文件
- `-oX`：将输出保存为XML文件

示例：

```
nmap -v -p 80,443 --script vuln -oN scan_report.txt example.com
```