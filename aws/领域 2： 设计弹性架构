# 任务表述 2.1： 设计可扩展的松散耦合架构。

松耦合架构（SQS、SNS、API Gateway、Lambda）

## 🧩 一、什么是松耦合架构（Loose Coupling Architecture）

### 🔹 定义

**松耦合**（Loose Coupling）指的是各个系统组件之间通过**异步通信、事件传递或消息中间件**来协作，而不是直接相互调用。

也就是说：

> 组件 A 不需要等待组件 B 执行完毕，而是把消息发出去就可以继续工作。

------

### 🔹 优势

| 特性       | 说明                                     |
| ---------- | ---------------------------------------- |
| **高可用** | 某个子系统宕机不会影响整个系统。         |
| **可扩展** | 可独立扩展不同组件（如增加消费者实例）。 |
| **弹性**   | 组件间通过队列缓冲流量，防止过载。       |
| **易维护** | 功能模块边界清晰，修改不会影响其他模块。 |
| **容错性** | 消息在系统中持久化，支持重试与重放。     |

------

### 🔹 AWS 提供的主要解耦组件

| 层级        | 服务                                  | 作用                           |
| ----------- | ------------------------------------- | ------------------------------ |
| 消息队列层  | **SQS (Simple Queue Service)**        | 异步传递消息，临时存储任务     |
| 发布/订阅层 | **SNS (Simple Notification Service)** | 一对多消息广播                 |
| API 接入层  | **API Gateway**                       | 提供统一的接口网关             |
| 计算触发层  | **Lambda**                            | 无服务器计算，响应事件执行逻辑 |

这些服务相互组合，就能构建出典型的松耦合架构👇

------

## 📨 二、Amazon SQS（Simple Queue Service）

### 🔹 概念

SQS 是一个**完全托管的消息队列服务**，用于解耦分布式系统中的生产者（Producer）和消费者（Consumer）。

------

### 🔹 核心模型

```
Producer → SQS Queue → Consumer
```

- Producer 发送消息到队列；
- 消息被暂存；
- Consumer 异步地拉取或轮询消息；
- 处理完成后删除消息。

------

### 🔹 队列类型

| 类型               | 特点                                   | 使用场景                           |
| ------------------ | -------------------------------------- | ---------------------------------- |
| **Standard Queue** | 高吞吐量、消息至少投递一次（可能重复） | 通用异步任务处理（如日志处理）     |
| **FIFO Queue**     | 严格有序、消息仅投递一次               | 金融交易、订单处理等要求顺序的场景 |

------

### 🔹 功能与属性

- **Visibility Timeout**：防止重复处理（消费者处理期间消息被隐藏）。
- **Dead Letter Queue (DLQ)**：失败多次的消息自动转入死信队列。
- **Message Retention**：消息可保存 1 分钟到 14 天。
- **Delay Queue**：延迟消息处理。
- **批量接收**：一次最多接收 10 条。

------

### 🔹 最佳实践

✅ 使用 **DLQ** 存放失败消息。
 ✅ 使用 **FIFO** 队列处理有序任务。
 ✅ 结合 **Lambda** 自动触发消费者逻辑（Serverless 模式）。
 ✅ 启用 **加密（KMS）** 确保消息安全。

------

## 📣 三、Amazon SNS（Simple Notification Service）

### 🔹 概念

SNS 是一个**发布/订阅（Pub/Sub）系统**，支持 **一对多的异步消息分发**。

------

### 🔹 模型结构

```
Publisher → SNS Topic → 多个 Subscriber
```

一个 SNS 主题（Topic）可以有多个订阅者（Subscriber）：

- SQS 队列
- Lambda 函数
- HTTP(S) 端点
- Email / SMS
- Kinesis Data Firehose（日志分析）

------

### 🔹 使用场景

- 应用程序间事件广播（如“订单完成”事件）
- 通知多系统（如推送到日志分析 + 邮件报警）
- 与 SQS 组合实现扇出（Fan-out）架构

------

### 🔹 SNS + SQS 扇出架构示例

```
Producer → SNS Topic
             ├── SQS Queue A → System A
             ├── SQS Queue B → System B
             └── Lambda → Process C
```

> 当 Publisher 向 SNS 发送一条消息，SNS 会自动将该消息推送给所有订阅者，实现广播。

------

### 🔹 最佳实践

✅ 使用 **SNS + SQS** 组合实现系统解耦；
 ✅ 使用 **消息过滤（Message Filter Policy）** 限定订阅者接收的消息类型；
 ✅ 启用 **Server-side Encryption（SSE）** 加密消息；
 ✅ SNS 可触发 **Lambda 函数** 实现事件驱动计算。

------

## 🌐 四、Amazon API Gateway

### 🔹 概念

**API Gateway** 是一个完全托管的服务，用于创建、发布、保护和监控 API。
 它是系统前端访问的**统一入口**（Entry Point），通常位于微服务架构的最前端。

------

### 🔹 支持类型

| 类型              | 用途                                 |
| ----------------- | ------------------------------------ |
| **REST API**      | 传统 RESTful 接口，灵活强大          |
| **HTTP API**      | 轻量级、低延迟版本（推荐用于新项目） |
| **WebSocket API** | 双向实时通信（聊天、推送）           |

------

### 🔹 主要功能

- **身份认证**（Cognito / IAM / Lambda Authorizer）
- **请求限制与节流（Throttling）**
- **缓存（API Gateway Cache）**
- **集成后端（Lambda、EC2、ECS、S3、DynamoDB）**
- **监控与日志（CloudWatch Metrics + Logs）**

------

### 🔹 典型架构模式

```
Client → API Gateway → Lambda → DynamoDB
```

这种无服务器模式极受欢迎：

- 无需管理服务器；
- 可弹性伸缩；
- 按调用计费。

------

### 🔹 最佳实践

✅ 使用 **Lambda Proxy Integration** 简化请求转发；
 ✅ 启用 **WAF** 防御攻击；
 ✅ 启用 **CloudFront + API Gateway + ACM** 形成 HTTPS 安全边界；
 ✅ 使用 **Stage Variables** 管理测试、生产环境的差异配置。

------

## ⚙️ 五、AWS Lambda（无服务器计算）

### 🔹 概念

**AWS Lambda** 是一个无服务器计算服务，可以根据事件自动执行代码。
 你只需上传函数，Lambda 会在需要时自动运行并扩展。

------

### 🔹 支持语言

Python、Node.js、Go、Java、C#、Ruby、Rust 等。

------

### 🔹 常见触发方式

- S3（对象上传触发）
- API Gateway（HTTP 请求触发）
- SNS / SQS（消息事件触发）
- CloudWatch（定时任务）
- DynamoDB Streams（数据变化触发）

------

### 🔹 优势

| 特性       | 说明                             |
| ---------- | -------------------------------- |
| 无需服务器 | 不需要 EC2，完全托管             |
| 自动扩展   | 根据并发请求数自动扩容           |
| 按使用计费 | 按调用次数和执行时间计费         |
| 安全集成   | 可通过 IAM 控制访问其他 AWS 服务 |

------

### 🔹 典型架构：事件驱动（Event-driven）

```
S3 Upload → Lambda → DynamoDB
```

文件上传后自动触发处理逻辑（如图像缩放、日志入库）。

------

### 🔹 最佳实践

✅ 函数粒度小、职责单一；
 ✅ 设置合理超时和内存（默认 3s，可调至 15min）；
 ✅ 使用 **环境变量 + Secrets Manager** 存储敏感信息；
 ✅ 结合 **DLQ** 或 **Event Retry Policy** 处理失败事件；
 ✅ 避免冷启动影响（通过预热或 Provisioned Concurrency）。

------

## 🧠 六、松耦合架构的典型模式

### 🔹 1️⃣ 异步处理模式

```
Client → API Gateway → Lambda → SQS → Worker Lambda → DynamoDB
```

> 用户发起请求，前端立即响应（提交成功），后台异步处理任务。

### 🔹 2️⃣ 扇出（Fan-out）模式

```
Lambda → SNS Topic
           ├── SQS Queue A
           ├── SQS Queue B
           └── Lambda C
```

> 一个事件触发多个后端系统同步处理。

### 🔹 3️⃣ 事件驱动日志分析

```
CloudWatch Logs → Subscription Filter → Lambda → S3 → Athena
```

------

## 🧰 七、考试与架构要点总结

| 服务            | 关键点                                  | 常见考题方向                   |
| --------------- | --------------------------------------- | ------------------------------ |
| **SQS**         | 异步队列、FIFO、DLQ、Visibility Timeout | 如何防止过载或消息丢失？       |
| **SNS**         | 发布/订阅、多订阅者广播、过滤策略       | 如何向多个系统分发通知？       |
| **API Gateway** | 前端入口、身份认证、限流、Lambda 集成   | 如何保护和统一访问接口？       |
| **Lambda**      | 无服务器、事件驱动、自动扩展            | 如何在上传文件时自动处理任务？ |

------

## 🧭 八、综合架构示意图（松耦合系统全景）

```
           ┌───────────────┐
           │   API Gateway  │
           └──────┬────────┘
                  │
                  ▼
           ┌───────────────┐
           │    Lambda      │
           │  (Producer)    │
           └──────┬────────┘
                  │
                  ▼
           ┌───────────────┐
           │     SNS Topic  │ ← 一对多广播
           └──────┬────────┘
       ┌──────────┼──────────┐
       ▼           ▼          ▼
   SQS QueueA   SQS QueueB  LambdaC
   (Billing)    (Analytics) (Email)
       │           │          │
       ▼           ▼          ▼
  Worker Lambda  Redshift   SES
```

该架构特点：

- 松耦合（SNS + SQS）
- 异步处理（Lambda 异步执行）
- 自动扩展（Serverless）
- 高弹性（SQS 缓冲峰值流量）

------

## ✅ 九、总结表

| 组件            | 作用                         | 类型          | 特点                 |
| --------------- | ---------------------------- | ------------- | -------------------- |
| **SQS**         | 异步队列，解耦生产者与消费者 | 队列服务      | 消息缓冲、可靠传递   |
| **SNS**         | 广播消息，多订阅者           | 发布/订阅系统 | 一对多、低延迟       |
| **API Gateway** | 前端统一访问入口             | 接口网关      | 安全、可监控、限流   |
| **Lambda**      | 事件驱动计算单元             | 无服务器函数  | 自动扩展、按调用计费 |

# 任务表述 2.2： 设计高可用性架构和/或容错架构。

高可用与容错（多可用区、Route53、Auto Scaling）

## 🧭 一、核心概念：高可用与容错的区别

| 概念               | 英文              | 目标                           | 特点                         |
| ------------------ | ----------------- | ------------------------------ | ---------------------------- |
| **高可用（HA）**   | High Availability | 保证系统在部分组件故障时仍可用 | 自动恢复、冗余部署、快速切换 |
| **容错（FT）**     | Fault Tolerance   | 系统在组件失效时不受任何影响   | 实时冗余、双活、自动无缝切换 |
| **灾难恢复（DR）** | Disaster Recovery | 在严重故障后恢复系统           | 异地备份、RTO/RPO 目标       |

✅ 记忆口诀：

- **高可用** = “出问题能自愈”
- **容错** = “出问题都不影响业务”

------

## 🧩 二、核心组成部分

AWS 提供了一整套实现高可用架构的组件和机制：

| 层级   | 实现手段                         | 关键服务                         |
| ------ | -------------------------------- | -------------------------------- |
| 物理层 | 多区域（Region）、多可用区（AZ） | AWS Global Infrastructure        |
| 网络层 | DNS 故障转移、负载均衡           | Route 53、Elastic Load Balancing |
| 计算层 | 自动伸缩、跨区部署               | EC2 Auto Scaling、ECS、Lambda    |
| 存储层 | 多副本存储、快照备份             | S3、EBS、RDS Multi-AZ            |
| 应用层 | 异步队列与解耦                   | SQS、SNS、Lambda                 |

------

## 🌍 三、多可用区架构（Multi-AZ Architecture）

### 🔹 概念

一个 **Region（区域）** 通常包含多个 **Availability Zones（可用区）**。
 每个可用区是物理隔离的数据中心，拥有独立的电力、网络与安全。

设计原则：

> 不要把所有计算和数据库资源都放在一个可用区内。
>  通过 **跨 AZ 部署** 提高可用性与容错性。

------

### 🔹 应用场景

#### 1️⃣ EC2 + ALB 多可用区部署

```
      ┌───────────────┐
      │ Route 53 (DNS)│
      └──────┬────────┘
             │
             ▼
       ┌────────────┐
       │   ALB (跨AZ)│
       └──────┬──────┘
       ┌──────┴──────┐
  EC2 in AZ-A     EC2 in AZ-B
```

- ALB 自动将流量分发至不同 AZ 的实例；
- 如果一个 AZ 宕机，流量自动路由到另一个；
- EC2 Auto Scaling 可动态启动替代实例。

------

#### 2️⃣ RDS Multi-AZ（数据库高可用）

RDS 可以开启 “**Multi-AZ**” 模式：

- 主实例（Primary）与备用实例（Standby）位于不同的 AZ；
- 数据通过同步复制；
- 故障时自动切换，无需人工干预。

```
App → RDS Endpoint → Primary (AZ-A)
                        │
                        ▼
                   Standby (AZ-B)
```

切换后 Endpoint 不变（DNS 自动更新），应用无需修改连接。

------

#### 3️⃣ S3 和 DynamoDB 的区域级冗余

- **S3**：在单个区域内自动存储多个副本，天然高可用；
- **DynamoDB**：自动跨多 AZ 复制，提供单区域高可用与全球表（Global Table）。

------

### 🔹 最佳实践

✅ 跨 AZ 部署负载均衡和计算实例；
 ✅ RDS 启用 Multi-AZ 复制；
 ✅ 使用 EBS 快照备份跨区存储；
 ✅ 不要将高可用架构仅限于单 AZ。

------

## 🌐 四、Route 53（DNS 与故障转移）

### 🔹 概念

**Amazon Route 53** 是一个**高可用的 DNS 服务**，可以将用户请求智能地路由到健康的终端。
 它支持全球流量分配与自动故障切换，是构建容错架构的关键组件。

------

### 🔹 核心功能

| 功能                                    | 说明                       |
| --------------------------------------- | -------------------------- |
| **DNS 解析**                            | 将域名解析为 IP 地址       |
| **健康检查（Health Check）**            | 自动检测终端是否可用       |
| **故障转移（Failover Routing）**        | 终端失效时自动切换备用站点 |
| **地理位置路由（Geolocation Routing）** | 根据用户地理位置路由流量   |
| **加权路由（Weighted Routing）**        | 按权重分配流量             |
| **延迟路由（Latency Routing）**         | 将流量引导到延迟最低的区域 |

------

### 🔹 常见架构示例

#### 1️⃣ 主备站点切换（Failover）

```
用户请求
   │
Route 53 (Health Check)
   ├── 主站 (us-east-1) ✅
   └── 备站 (us-west-2) ❌ ← 故障切换时启用
```

当主站无响应时，Route 53 自动将流量路由到备站。

------

#### 2️⃣ 延迟路由（Latency Routing）

```
  亚太用户 → 东京 Region
  欧洲用户 → 法兰克福 Region
  美国用户 → 弗吉尼亚 Region
```

自动根据网络延迟选择最近的 Region。

------

#### 3️⃣ 加权路由（A/B 测试）

```
Route 53
 ├── 80% → 旧版本 ALB
 └── 20% → 新版本 ALB
```

用于灰度发布或金丝雀测试（Canary Release）。

------

### 🔹 最佳实践

✅ 对关键服务启用 **健康检查 + Failover Routing**；
 ✅ 使用 **Latency Routing** 提升全球性能；
 ✅ 启用 **CloudWatch 告警** 监控 DNS 健康状态；
 ✅ 搭配 CloudFront 提供全球内容分发。

------

## ⚙️ 五、Auto Scaling（自动伸缩）

### 🔹 概念

**Auto Scaling** 可以根据负载自动调整计算资源数量，确保系统既能在高峰时保持性能，又能在低谷时节约成本。

它是高可用与成本优化的核心机制。

------

### 🔹 类型

| 类型                              | 服务                  | 说明                  |
| --------------------------------- | --------------------- | --------------------- |
| **EC2 Auto Scaling**              | EC2 实例              | 自动增加/减少实例数量 |
| **Application Auto Scaling**      | ECS、DynamoDB、Lambda | 调整非 EC2 资源容量   |
| **AWS Auto Scaling (统一控制台)** | 集成多种伸缩策略      | 自动化全局伸缩管理    |

------

### 🔹 核心概念

| 概念                                       | 说明                                 |
| ------------------------------------------ | ------------------------------------ |
| **Auto Scaling Group (ASG)**               | 一组逻辑上相同的 EC2 实例            |
| **Launch Template / Launch Configuration** | 定义实例的 AMI、类型、密钥对、安全组 |
| **Scaling Policy**                         | 定义何时扩容或缩容                   |
| **Health Check**                           | 检测实例健康，自动替换异常实例       |

------

### 🔹 扩缩容策略

| 策略类型                           | 说明                                              |
| ---------------------------------- | ------------------------------------------------- |
| **动态策略（Dynamic Scaling）**    | 根据 CloudWatch 指标触发，例如 CPU > 80% 增加实例 |
| **预测策略（Predictive Scaling）** | 根据历史负载预测未来需求（机器学习驱动）          |
| **计划策略（Scheduled Scaling）**  | 按固定时间表扩缩容（如白天扩容，夜间缩容）        |

------

### 🔹 高可用设计

- 在 **多个 AZ 中部署实例**；
- 与 **ALB/NLB** 结合实现自动负载分配；
- Auto Scaling Group 自动替换失败实例；
- 与 **CloudWatch + SNS** 联动发出警报。

------

### 🔹 示例架构

```
             ┌────────────────────┐
             │    Route 53 (DNS)   │
             └────────┬───────────┘
                      │
                      ▼
              ┌─────────────┐
              │  ALB (跨AZ) │
              └──────┬──────┘
          ┌──────────┴──────────┐
          │                     │
     EC2 (AZ-A)            EC2 (AZ-B)
          │                     │
   Auto Scaling Group (Min 2, Max 6)
```

------

### 🔹 最佳实践

✅ 在至少两个 AZ 中部署 Auto Scaling Group；
 ✅ 使用 **ALB + ASG** 组合实现自动容错；
 ✅ 设置合理的最小实例数（MinSize ≥ 2）；
 ✅ 使用 **健康检查（EC2 + ELB）** 自动替换坏实例；
 ✅ 启用 **Lifecycle Hooks** 实现安全扩缩容前置任务（如配置、预热）。

------

## 🧠 六、典型考试场景总结

| 场景         | 正确设计                           |
| ------------ | ---------------------------------- |
| EC2 实例宕机 | Auto Scaling Group 自动替换        |
| 单 AZ 宕机   | 跨 AZ 部署 ALB 与 EC2              |
| 数据库高可用 | RDS Multi-AZ                       |
| DNS 故障转移 | Route 53 Failover Routing          |
| 全球性能优化 | Route 53 Latency Routing           |
| 弹性伸缩     | Auto Scaling 根据 CPU/请求量扩缩容 |

------

## 🧾 七、完整高可用架构图

```
           ┌────────────────────────────┐
           │        Route 53            │
           │ (健康检查 + 延迟路由)       │
           └────────────┬──────────────┘
                        │
                        ▼
              ┌────────────────────┐
              │ Application LB (跨AZ)│
              └─────────┬──────────┘
                ┌────────┴────────┐
                │                 │
         EC2 in AZ-A        EC2 in AZ-B
         (ASG 自动伸缩)     (ASG 自动伸缩)
                │                 │
                └───────┬─────────┘
                        ▼
              ┌────────────────────┐
              │ RDS Multi-AZ (主备) │
              └────────────────────┘
```

特点：

- 多 AZ + Auto Scaling → **高可用**
- Route 53 + ALB → **自动故障转移**
- RDS Multi-AZ → **数据库容错**

------

## ✅ 八、总结对比表

| 层级       | 服务             | 关键能力               | 功能总结               |
| ---------- | ---------------- | ---------------------- | ---------------------- |
| **网络层** | Route 53         | DNS 故障转移、延迟路由 | 确保请求指向健康终端   |
| **计算层** | EC2 Auto Scaling | 自动扩缩容、实例替换   | 保持系统容量与性能     |
| **应用层** | ALB              | 负载均衡、健康检查     | 分发流量与剔除故障实例 |
| **数据层** | RDS Multi-AZ     | 数据同步、自动故障切换 | 提供持久与容错存储     |

灾备策略（RPO/RTO、跨区备份）



## ☁️ 一、什么是灾难恢复（Disaster Recovery, DR）

灾难恢复（DR）指的是在**区域级别（Region-level）或大规模中断**发生后，系统**能多快恢复业务运行**的能力。

常见灾难包括：

- 区域级服务中断（Region Outage）；
- 网络大规模中断；
- 数据损坏；
- 误删除；
- 自然灾害（地震、火灾、电力中断）。

------

## 🧩 二、关键指标：RTO 与 RPO

| 指标    | 英文全称                 | 含义                                   | 举例                                             |
| ------- | ------------------------ | -------------------------------------- | ------------------------------------------------ |
| **RTO** | Recovery Time Objective  | 灾难发生后系统恢复到可用状态的目标时间 | 如果 RTO = 1 小时，系统必须在 1 小时内恢复服务   |
| **RPO** | Recovery Point Objective | 灾难发生时可容忍的数据丢失时间范围     | 如果 RPO = 15 分钟，最多只能丢失 15 分钟内的数据 |

✅ 口诀：

- **RTO → 恢复要多快**
- **RPO → 数据能丢多少**

------

### 🔹 举例理解

| 场景                 | RTO     | RPO     | 说明                                 |
| -------------------- | ------- | ------- | ------------------------------------ |
| 电商系统要求快速恢复 | 15 分钟 | 5 分钟  | 系统需要有热备份，数据同步频繁       |
| 内部报表系统         | 24 小时 | 12 小时 | 可接受延迟恢复，使用冷备或定期备份   |
| 银行核心交易系统     | 1 分钟  | 0 秒    | 几乎不允许数据丢失或停机，需多活架构 |

------

## 🧠 三、AWS 灾备设计的四种模式（经典 4 层 DR 模型）

AWS 官方将灾备架构分为 **4 种等级**，根据 **成本、RTO、RPO** 的不同进行权衡：

| 级别 | 模式                                     | 成本   | RTO          | RPO      | 特点                           |
| ---- | ---------------------------------------- | ------ | ------------ | -------- | ------------------------------ |
| 1️⃣    | **Backup and Restore（备份与恢复）**     | 💰 最低 | ⏱ 数小时到天 | ⏱ 几小时 | 仅备份数据，无备用环境         |
| 2️⃣    | **Pilot Light（点火模式）**              | 💰 较低 | ⏱ 几小时     | ⏱ 几分钟 | 关键组件预配置，灾难时手动扩容 |
| 3️⃣    | **Warm Standby（暖备模式）**             | 💰 中等 | ⏱ 几分钟     | ⏱ 秒级   | 关键系统在备用区运行，容量较低 |
| 4️⃣    | **Multi-Site Active/Active（多活模式）** | 💰 最高 | ⏱ 几秒       | ⏱ 0      | 主备同时在线，自动故障切换     |

------

## 1️⃣ Backup & Restore（备份与恢复）

### 🔹 原理

- 将数据（S3、EBS、RDS、DynamoDB）定期备份到另一个 Region；
- 发生灾难时，在备用 Region 手动重建环境。

### 🔹 架构示意

```
Primary Region
  ├── EC2 / RDS / S3
  │
  ▼
Cross-Region Backup → S3 in Backup Region
```

### 🔹 服务组合

- S3 Cross-Region Replication (CRR)
- RDS Snapshot + Export to S3
- DynamoDB Backup
- CloudFormation 模板重建资源

### 🔹 特点

✅ 成本最低；
 ❌ 恢复时间长（需要人工部署）；
 ✅ 适合非关键业务或测试环境。

------

## 2️⃣ Pilot Light（点火模式）

### 🔹 原理

- 在备用 Region 中 **预先配置核心组件（如数据库、IAM、VPC）**；
- 其余组件（如 EC2 实例）在灾难时按需快速启动。

### 🔹 架构示意

```
Primary Region
   │
   ▼
  DB Replication → Standby DB in DR Region
   │
   ▼
  (App Servers Off, ready to launch)
```

### 🔹 服务组合

- RDS Read Replica / Aurora Global Database
- EC2 AMI + CloudFormation 自动部署
- S3 Cross-Region Replication

### 🔹 特点

✅ 数据实时同步；
 ✅ 恢复时间可控制在数小时内；
 ❌ 仍需手动扩容计算层；
 ✅ 成本较低。

------

## 3️⃣ Warm Standby（暖备模式）

### 🔹 原理

- 灾备 Region 有完整系统，但运行容量较低；
- 在灾难时快速扩容到生产级规模。

### 🔹 架构示意

```
Region A (Primary)
   ├── Full Production Load
Region B (Warm Standby)
   ├── Partial Load (Active but Low Capacity)
```

### 🔹 服务组合

- Auto Scaling（灾难时扩容）
- RDS Multi-Region Replication / Aurora Global
- Route 53 Health Check + Failover Routing

### 🔹 特点

✅ 恢复时间短（几分钟内）；
 ✅ 数据丢失极少；
 ❌ 成本中等（部分资源持续运行）。

------

## 4️⃣ Multi-Site Active/Active（多活模式）

### 🔹 原理

- 两个或多个 Region **同时在线**；
- 用户流量通过 Route 53 智能路由分配；
- 任何 Region 故障时，流量立即切换。

### 🔹 架构示意

```
        ┌───────────────────┐
        │ Route 53 (Latency Routing) │
        └────────────┬─────────────┘
             ┌────────┴────────┐
             ▼                 ▼
      Region A (Active)   Region B (Active)
```

### 🔹 服务组合

- Route 53 Latency / Geolocation Routing
- DynamoDB Global Table
- Aurora Global Database
- S3 Multi-Region Access Point
- CloudFront + WAF

### 🔹 特点

✅ 实时容错（RTO≈0）；
 ✅ 数据几乎不丢（RPO≈0）；
 ❌ 成本最高；
 ✅ 适合金融、游戏、核心电商系统。

------

## 🌍 四、跨区备份与复制策略

AWS 提供多种**跨 Region 备份与同步机制**，用于不同层级的数据保护。

| 服务                                  | 功能                            | 实现方式                      |
| ------------------------------------- | ------------------------------- | ----------------------------- |
| **S3 Cross-Region Replication (CRR)** | 自动复制对象到其他 Region 的 S3 | 需启用版本控制                |
| **EBS Snapshot Copy**                 | 手动或定期复制快照              | 支持 Lambda 自动化            |
| **RDS Snapshot Copy / Read Replica**  | 数据库备份或异步只读副本        | Aurora Global DB 支持同步复制 |
| **DynamoDB Global Table**             | 多 Region 实时数据复制          | 低延迟、强一致性              |
| **CloudFormation StackSets**          | 跨 Region 自动部署资源模板      | 基础设施级灾备                |
| **AWS Backup**                        | 集中化备份管理，支持跨区域存储  | 一键备份与恢复策略            |

------

## 🧰 五、灾备架构典型示意

```
                   ┌─────────────────────┐
                   │    Route 53 (DNS)   │
                   └──────────┬──────────┘
                              │
                 ┌────────────┴────────────┐
                 ▼                         ▼
        Primary Region               DR Region
        ┌──────────────┐           ┌──────────────┐
        │  EC2 / RDS    │ ←→ Replication → │  EC2 / RDS Standby│
        ├──────────────┤           ├──────────────┤
        │   S3 Bucket   │ ←→ CRR → │   S3 Backup   │
        └──────────────┘           └──────────────┘
```

- RDS 使用 **Aurora Global Database** 或 **Read Replica** 实现跨区复制；
- S3 使用 **Cross-Region Replication**；
- Route 53 通过 **Failover Routing** 自动切换流量。

------

## 🧱 六、考试与实践重点总结

| 考点                       | 关键理解                                                     |
| -------------------------- | ------------------------------------------------------------ |
| **RTO vs RPO**             | RTO → 恢复时间；RPO → 数据丢失                               |
| **灾备等级 4 模式**        | 从低到高：Backup → Pilot Light → Warm Standby → Multi-site Active |
| **RDS 灾备**               | Multi-AZ = 同区高可用，Read Replica = 跨区灾备               |
| **S3 CRR**                 | 必须启用版本控制                                             |
| **Route 53 Failover**      | 主站故障时自动切换到备用站点                                 |
| **Aurora Global Database** | 延迟 < 1 秒，支持跨区快速切换                                |
| **AWS Backup**             | 集中化跨服务灾备策略                                         |

------

## 🧾 七、总结对比表

| 模式                         | 成本   | RTO            | RPO          | 适用场景               |
| ---------------------------- | ------ | -------------- | ------------ | ---------------------- |
| **Backup & Restore**         | 💰 低   | ⏱ 长（小时）   | ⏱ 长（小时） | 非关键系统、开发测试   |
| **Pilot Light**              | 💰 较低 | ⏱ 中等（小时） | ⏱ 低（分钟） | 中小型应用             |
| **Warm Standby**             | 💰 中   | ⏱ 短（分钟）   | ⏱ 短（秒）   | 中大型关键系统         |
| **Multi-Site Active/Active** | 💰 高   | ⏱ 几秒         | ⏱ 0          | 核心交易系统、全球业务 |

------

## 🧩 八、典型设计建议

✅ 始终将备份存放在**不同 Region**；
 ✅ 结合 **AWS Backup** 自动化周期备份与生命周期管理；
 ✅ 对数据库启用 **跨区只读副本（Read Replica）**；
 ✅ 使用 **Route 53 + Health Check** 自动流量切换；
 ✅ 定期测试灾备演练（DR Drill），验证恢复流程。

















